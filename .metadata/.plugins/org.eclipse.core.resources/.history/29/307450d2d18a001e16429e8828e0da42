/*
 * app.c
 *
 *  Created on: Nov 23, 2023
 *      Author: Johann Courand
 */

#include "stm32l4xx_hal.h"
#include "app.h"
#include <string.h>
#include <stdio.h>

extern UART_HandleTypeDef huart2;
extern ADC_HandleTypeDef hadc1;


uint16_t ir_sensor1; //analogique port A0
uint16_t ir_sensor2; //digital port D2
uint16_t ir_sensor3; //analogique port A1
uint16_t ir_sensor4; //digital port D4

char msg[30];

void reading_sensor1()
{
	HAL_ADC_Start(&hadc1);
	HAL_ADC_PollForConversion(&hadc1, 100);

	ir_sensor1 = HAL_ADC_GetValue(&hadc1);

	HAL_ADC_Stop(&hadc1);
}

void reading_sensor2()
{

	// IR_SENSOR_2
	ir_sensor2 = !(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_10));
}

void reading_sensor3()
{
	// ADC IR_SENSOR_1
	HAL_ADC_Start(&hadc1);
	HAL_ADC_PollForConversion(&hadc1, 100);

	ir_sensor3 = HAL_ADC_GetValue(&hadc1);

	HAL_ADC_Stop(&hadc1);
}


void reading_sensor4()
{

	// IR_SENSOR_2
	ir_sensor4 = !(HAL_GPIO_ReadPin(GPIOB, GPIO_PIN_5));
}


void sending_data_uart()
{
	reading_sensor1();
	reading_sensor2();
	reading_sensor3();
	reading_sensor4();

	sprintf(msg, "IR_SENSOR1=%hu|IR_SENSOR2=%u\r\n", ir_sensor1, ir_sensor2);


	HAL_UART_Transmit(&huart2, (const uint8_t *)msg, strlen(msg), 100);

	HAL_Delay(250);
}


